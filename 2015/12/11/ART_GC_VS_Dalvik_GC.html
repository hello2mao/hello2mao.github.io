<!doctype html>
<html>
<head>
  <meta charset="utf-8">
<title>Android 5.0 ART GC 对比 Android 4.x Dalvik GC | 毛宏斌的博客</title>
<meta name="author" content="Billy Mao">

  <meta name="keywords" content="android,GC">


<link rel="shortcut icon" href="/public/img/mhb-logo.png" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="/public/css/bootstrap.css">
<link rel="stylesheet" href="/public/css/font-awesome.css">
<link rel="stylesheet" href="/public/js/prettify/prettify.css">
<link rel="stylesheet" href="/public/css/base.css">
<link href="/pages/atom.xml" rel="alternate" title="毛宏斌的博客" type="application/atom+xml">
</head>
<body>
  <div class="container">
    <div class="row">
      <div class="col-md-3 col-lg-3 col-sm-13 col-xs-13 aside visible-md visible-lg">
  <div class="row">
    <div class="col-md-2 col-xs-2 aside1">
      <br>
      <a class="pjaxlink" href="/"><img src="/public/img/mhb-logo.png" class="img-ronuded avatar" style="border-width:0px; border-color:#000"></a>
      <br><br><br><br>
      <ul class="nav nav-pills nav-stacked">
        <li><a href="#tags" data-toggle="tab">分类</a></li>  
             <!-- 这里是aside1的技术、生活、工作、转载、链接-->
         <li><a href="#技术" data-toggle="tab">技术</a></li>
             <!-- 这里是aside1的技术、生活、工作、转载、链接-->
         <li><a href="#其他" data-toggle="tab">其他</a></li>
        
        <li><a class="pjaxlink" href="/pages/archive.html">归档</a></li>
        <li><a class="pjaxlink" href="/pages/about.html">关于</a></li>  
        <!-- <li><a href="#tags" data-toggle="tab"><i class="fa fa-tags fa-lg"></i></a></li>
        <li><a class="pjaxlink" href="/pages/archive.html"><i class="fa fa-archive fa-lg"></i></a></li>
        <li><a class="pjaxlink" href="/pages/about.html"><i class="fa fa-user fa-lg"></i></a></li>
        这是原来现实汉字的代码，我改为了图标 -->
      </ul>
      <div class="aside1_bottom">
        <table class="table table-condensed">
          <tr>
            <td><a href="/pages/atom.xml" target="_blank"><i class="fa fa-rss fa-lg" style="color:#fff;"></i></a></td>
            <td><a href="mailto:hello2mao@outlook.com"><i class="fa fa-envelope-o fa-lg" style="color:#fff;"></i></a></td>
          </tr>
        </table>
      </div>
    </div>
    <div class="col-md-10 col-xs-10 aside2">
      <div class="row">
        <div class="tab-content"> 
           
            <div class="tab-pane" id="技术">
              <div class="list-group">
                <!--<h2 class="center">技术</h2>-->     <!--原来aside2上面的大标题-->
                
                  <a href="/2015/12/16/Android_ART_GC_GrowForUtilization.html" class="list-group-item-lay pjaxlink">Android ART GC之GrowForUtilization的分析</a>
                
                  <a href="/2015/12/11/ART_GC_VS_Dalvik_GC.html" class="list-group-item-lay pjaxlink">Android 5.0 ART GC 对比 Android 4.x Dalvik GC</a>
                
                  <a href="/2015/12/06/Overview_of_gc_optimization_based_on_heap_growth.html" class="list-group-item-lay pjaxlink">基于动态堆增长技术的GC调优综述</a>
                
                  <a href="/2015/12/02/Linux_I2C_driver.html" class="list-group-item-lay pjaxlink">详解Linux-I2C驱动</a>
                
                  <a href="/2015/11/30/0xBenchmark.html" class="list-group-item-lay pjaxlink">0xBenchmark中垃圾回收测试模块的分析及改进</a>
                
              </div>
            </div>
           
            <div class="tab-pane" id="其他">
              <div class="list-group">
                <!--<h2 class="center">其他</h2>-->     <!--原来aside2上面的大标题-->
                
                  <a href="/2017/01/08/Data_Analysis_Job.html" class="list-group-item-lay pjaxlink">Data Analysis Job</a>
                
              </div>
            </div>
                
          <div class="tab-pane" id="tags">
            <div class="panel-group" id="accordion">
              <!--<h2 class="center">分类</h2>-->
               
                <div class="panel panel-info">
                  <div class="panel-heading">
                    <h4 class="panel-title">
                      <a data-toggle="collapse" data-toggle="collapse" data-parent="#accordion" href="#Android">Android</a>
                      <span class="badge pull-right">4</span>
                    </h4>
                  </div>
                  <div id="Android" class="panel-collapse collapse">
                    
                      <a  href='/2015/12/16/Android_ART_GC_GrowForUtilization.html' class="list-group-item pjaxlink">
                        Android ART GC之GrowForUtilization的分析
                      </a>
                    
                      <a  href='/2015/12/11/ART_GC_VS_Dalvik_GC.html' class="list-group-item pjaxlink">
                        Android 5.0 ART GC 对比 Android 4.x Dalvik GC
                      </a>
                    
                      <a  href='/2015/12/06/Overview_of_gc_optimization_based_on_heap_growth.html' class="list-group-item pjaxlink">
                        基于动态堆增长技术的GC调优综述
                      </a>
                    
                      <a  href='/2015/11/30/0xBenchmark.html' class="list-group-item pjaxlink">
                        0xBenchmark中垃圾回收测试模块的分析及改进
                      </a>
                    
                  </div>
                </div>
               
                <div class="panel panel-info">
                  <div class="panel-heading">
                    <h4 class="panel-title">
                      <a data-toggle="collapse" data-toggle="collapse" data-parent="#accordion" href="#Linux">Linux</a>
                      <span class="badge pull-right">1</span>
                    </h4>
                  </div>
                  <div id="Linux" class="panel-collapse collapse">
                    
                      <a  href='/2015/12/02/Linux_I2C_driver.html' class="list-group-item pjaxlink">
                        详解Linux-I2C驱动
                      </a>
                    
                  </div>
                </div>
               
                <div class="panel panel-info">
                  <div class="panel-heading">
                    <h4 class="panel-title">
                      <a data-toggle="collapse" data-toggle="collapse" data-parent="#accordion" href="#Other">Other</a>
                      <span class="badge pull-right">1</span>
                    </h4>
                  </div>
                  <div id="Other" class="panel-collapse collapse">
                    
                      <a  href='/2017/01/08/Data_Analysis_Job.html' class="list-group-item pjaxlink">
                        Data Analysis Job
                      </a>
                    
                  </div>
                </div>
              
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
      <div class="col-md-13 col-lg-13 col-sm-13 col-xs-13 aside3">
        <div id="container">
          <div id="pjax">
            <div class="row">
  <div class="col-md-13 aside3-title">
    <br>
    <h2 id="#identifier">Android 5.0 ART GC 对比 Android 4.x Dalvik GC</h2>
    2015年12月11日
  </div>
  <div class="col-md-13 aside3-content">
    <hr>
    <div id="content">
      <p><strong><em>版权声明：本文为博主原创文章，未经博主允许不得转载。</em></strong></p>

<p>为了研究Android虚拟机中的内存管理机制，前期进行了初步调研，下面列出Android 5.0 ART 中GC的更新概要以供参考，资料来源于网络以及对源码的初步阅读。  </p>

<p>谷歌在2014年6月26日的I/O 2014开发者大会上正式推出了Android L,有以下几个方面值得重点关注：</p>

<ol>
<li>全新的UI/UE设计风格和框架Material Design以及和通知（Notification）栏有关的UI/UE变化</li>
<li>能大幅改善系统运行速度的运行时库Android Runtime（简称ART）。</li>
<li>致力于改善功耗的Project Volta。</li>
</ol>

<p>其中第二点中得ART是Android Runtime的缩写，它是Google用于替代饱受诟病的Dalvik虚拟机的替代品。其实，ART早在Android KitKat（版本号为4.4）就已经推出，不过当时它还很不完善，所以被放到设置程序中的“开发者选项”里供一些供感兴趣的开发者使用。</p>

<p>ART究竟有什么神奇之处呢？根据相关资料，总结如下：<br>
（1）采用AOT（Ahead-Of-Time，预编译）编译技术，它能将Java字节码直接转换成目标机器的机器码。<br>
（2）更为高效和细粒度的垃圾回收机制（GC）。  </p>

<p>下面简短的介绍下android 5.0 ART GC 的改动：</p>

<p>（一）内存分配器  </p>

<ol>
<li><p>Dalvik<br>
在Android 系统C 语言库bionic 中直接使用了dlmalloc这一个十分流行的开源内存分配器。</p></li>
<li><p>ART<br>
参考<a href="http://blog.tek-life.com/understanding-ros-memory-allocator-in-art-virtual-machine/">http://blog.tek-life.com/understanding-ros-memory-allocator-in-art-virtual-machine/</a>
创建了一种名叫Runs-of-Slots-Allocator（RosAlloc）的分配器。这种分配器的特点是分配内存时，会采用更细粒度的锁控制。例如有不同的锁来保护不同的对象分配，或者当线程分配一些小尺寸对象时使用线程自己的堆栈，从而可完全不使用锁保护。同时这种分配器也更适合多线程的实现。<br>
据Google自己的数据，RosAlloc能达到最多10倍的速度提升.</p></li>
</ol>

<p>（二）垃圾回收算法</p>

<ol>
<li><p>Dalvik<br>
Dalvik的垃圾回收分为两个阶段。<br>
第一个阶段，Dalvik暂停所有的线程来分析堆的使用情况。<br>
第二个阶段，Dalvik暂停所有线程来清理堆。这就会导致应用在性能上的“卡顿”。  </p></li>
<li><p>ART<br>
ART改进后的垃圾回收算法只暂停线程一次。ART 能够做到这一点，是因为应用本身做了垃圾回收的一些工作。垃圾回收启动后，不再是两次暂停，而是一次暂停。在遍历阶段，应用不需要暂停，同时垃圾回收停时间也大大缩短，因为 Google使用了一种新技术（packard pre-cleaning），在暂停前就做了许多事情，减轻了暂停时的工作量。</p></li>
</ol>

<p>（三）超大对象存储空间的支持<br>
ART还引入了一个特殊的超大对象存储空间(large object space，LOS)，这个空间与堆空间是分开的，不过仍然驻留在应用程序内存空间中。这一特殊的设计是为了让ART可以更好的管理较大的对象，比如位图对象(bitmaps)。<br>
堆空间碎片化严重时，较大的对象会带来一些问题。比如，在分配一个此类对象时，相比其他普通对象，会导致垃圾收集器启动的次数增加很多。有了这个超大对象存储空间的支持，垃圾收集器因堆空间分段而引发调用次数将会大大降低，这样垃圾收集器就能做更加合理的内存分配，从而降低运行时开销。</p>

<p>（四）Moving GC策略<br>
ART为了解决堆空间内存碎片化的问题，近期提出了“Moving GC”的方法。其目的是清理堆栈以减少内存碎片。由于这个工作会导致应用程序长时间中断，所以它必须等程序退到后台时才能开展。核心思想是，当应用程序运行在后台时，将程序的堆空间做段合并操作。</p>

<p>（五）GC调度策略的多样性<br>
经过比较Dalvik和ART的源码后，发现ART中GC调度策略发生了很大的变动。<br>
具体来说分为以下几个方面  </p>
<div class="highlight"><pre><code class="language-" data-lang="">（a）GC触发方式  
（b）GC的种类  
（c）垃圾回收算法的多样性  
</code></pre></div>
<p>（a）GC触发方式<br>
（1）Dalvik<br>
  GC触发方式主要有GC<em>FOR</em>MALLOC;GC<em>CONCURRENT;GC</em>EXPLICIT;GC<em>BEFORE</em>OOM这四种。<br>
（2）ART</p>
<div class="highlight"><pre><code class="language-" data-lang="">enum GcCause {  
  // GC triggered by a failed allocation. Thread doing allocation is blocked waiting for GC before  
  // retrying allocation.  
  kGcCauseForAlloc,  
  // A background GC trying to ensure there is free memory ahead of allocations.  
  kGcCauseBackground,  
  // An explicit System.gc() call.  
  kGcCauseExplicit,  
  // GC triggered for a native allocation.  
  kGcCauseForNativeAlloc,  
  // GC triggered for a collector transition.  
  kGcCauseCollectorTransition,  
  // Not a real GC cause, used when we disable moving GC (currently for     GetPrimitiveArrayCritical).  
  kGcCauseDisableMovingGc,  
  // Not a real GC cause, used when we trim the heap.  
  kGcCauseTrim,  
  // GC triggered for background transition when both foreground and background     collector are CMS.  
  kGcCauseHomogeneousSpaceCompact, 
};  
</code></pre></div>
<p>（b）GC的种类<br>
（1）Dalvik<br>
就一种GC(并发、非并发)<br>
（2）ART<br>
三种GC(并发、非并发)：快速GC策略Sticky GC；局部GC策略Partial GC；全局GC策略Full GC。</p>
<div class="highlight"><pre><code class="language-" data-lang="">enum GcType {  
  // Placeholder for when no GC has been performed.  
  kGcTypeNone,  
  // Sticky mark bits GC that attempts to only free objects allocated since the last GC.  
  kGcTypeSticky,  
  // Partial GC that marks the application heap but not the Zygote.
  kGcTypePartial,  
  // Full GC that marks and frees in both the application and Zygote heap. 
  kGcTypeFull,  
  // Number of different GC types.  
  kGcTypeMax, 
};  
</code></pre></div>
<p>（c）垃圾回收算法的多样性<br>
（1）Dalvik<br>
两种：串行Mark-Sweep算法、并行Mark-Sweep算法<br>
（2）ART  </p>
<div class="highlight"><pre><code class="language-" data-lang="">enum CollectorType {  
// No collector selected.  
kCollectorTypeNone,  
// Non concurrent mark-sweep.  
kCollectorTypeMS,  
// Concurrent mark-sweep.  
kCollectorTypeCMS,  
// Semi-space / mark-sweep hybrid, enables compaction.  
kCollectorTypeSS,  
// A generational variant of kCollectorTypeSS.  
kCollectorTypeGSS,  
// Mark compact colector.  
kCollectorTypeMC,  
// Heap trimming collector, doesn't do any actual collecting.  
kCollectorTypeHeapTrim,  
// A (mostly) concurrent copying collector.  
kCollectorTypeCC,  
// A homogeneous space compaction collector used in background transition  
// when both foreground and background collector are CMS.  
kCollectorTypeHomogeneousSpaceCompact,  
};  
</code></pre></div>
<p>可以看到，除了标记清楚算法，基于半空间（semi-space）的拷贝算法也实现了，其中GSS（分代半空间拷贝算法）的实现具有很大的研究性。</p>

<p>上面只是初步的认识，很多地方得详细研究后才能确定。</p>

<p>参考：<br>
【1】<a href="http://www.cnblogs.com/jinkeep/p/3818180.html">http://www.cnblogs.com/jinkeep/p/3818180.html</a>  【原创】【Android】揭秘 ART 细节 ---- Garbage collection<br>
【2】<a href="https://www.infinum.co/the-capsized-eight/articles/art-vs-dalvik-introducing-the-new-android-runtime-in-kit-kat">https://www.infinum.co/the-capsized-eight/articles/art-vs-dalvik-introducing-the-new-android-runtime-in-kit-kat</a><br>
【3】<a href="http://www.lingcc.com/2014/07/16/12599/">http://www.lingcc.com/2014/07/16/12599/</a>  近距离端详Android ART运行时库<br>
【4】<a href="http://blog.tek-life.com/understanding-garbage-collector-in-art-of-android/">http://blog.tek-life.com/understanding-garbage-collector-in-art-of-android/</a>   </p>

    </div>
    <hr>
    <!-- 多说评论框 start -->
	<div class="ds-thread" data-thread-key="/2015/12/11/ART_GC_VS_Dalvik_GC" data-title="Android 5.0 ART GC 对比 Android 4.x Dalvik GC" data-url="hello2mao.github.io/2015/12/11/ART_GC_VS_Dalvik_GC.html"></div>
<!-- 多说评论框 end -->
<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
<script type="text/javascript">
var duoshuoQuery = {short_name:"hello2mao"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
<!-- 多说公共JS代码 end -->
  </div>
  <!-- 目录 -->
  <div id="content_table" style="position:fixed;right:20px;top:120px;display:none;">
    <div class="panel panel-success">
      <div class="panel-body" id="nav"></div>
    </div>
  </div>
</div>


          </div>
        </div>
      </div>
    </div>
  </div>
  <div style="position:fixed;right:15px;top:62px;">
  <button id="content_btn" class="btn btn-primary" style="width:43px; height:34px;">
    <i class="fa fa-lg fa-plus"></i>
  </button>
</div>
<div style="position:fixed;right:15px;top:20px;">
  <button id="nav_btn" class="btn btn-primary">
    <i class="fa fa-lg fa-navicon"></i>
  </button>
</div>
<script type="text/javascript" src="/public/js/jquery.js"></script>
<script type="text/javascript" src="/public/js/bootstrap.js"></script>
<script src="/public/js/jquery.pjax.js"></script>
<script src="/public/js/prettify/prettify.js"></script>
<script src="/public/js/base.js"></script>
<!--
<script src="/public/js/jquery.scrollUp.js"></script>
-->
<script>
    $('a[href="#tags"]').tab('show');
</script>


<!--button是右上方导航和显示目录的按钮-->


  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', '', '');
  ga('send', 'pageview');
</script>
</body>
</html>